package com.example.musep50.ui

import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.Toast
import androidx.fragment.app.DialogFragment
import androidx.fragment.app.viewModels
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.LinearLayoutManager
import com.example.musep50.data.entities.Payer
import com.example.musep50.databinding.DialogManageParticipantsBinding
import com.example.musep50.ui.adapter.ParticipantAdapter
import com.example.musep50.viewmodel.PayerViewModel
import kotlinx.coroutines.launch

class ManageParticipantsDialog(
    private val eventId: Long,
    private val eventName: String
) : DialogFragment() {

    private var _binding: DialogManageParticipantsBinding? = null
    private val binding get() = _binding!!
    private val payerViewModel: PayerViewModel by viewModels()
    private lateinit var adapter: ParticipantAdapter

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        _binding = DialogManageParticipantsBinding.inflate(inflater, container, false)
        return binding.root
    }

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        dialog?.window?.setBackgroundDrawableResource(android.R.color.transparent)
        dialog?.window?.setLayout(
            ViewGroup.LayoutParams.MATCH_PARENT,
            ViewGroup.LayoutParams.WRAP_CONTENT
        )

        binding.eventNameText.text = "Événement: $eventName"

        setupRecyclerView()
        setupButtons()
        observeParticipants()
    }

    private fun setupRecyclerView() {
        adapter = ParticipantAdapter { payer ->
            deleteParticipant(payer)
        }

        binding.participantsRecyclerView.layoutManager = LinearLayoutManager(requireContext())
        binding.participantsRecyclerView.adapter = adapter
    }

    private fun setupButtons() {
        binding.btnAddParticipant.setOnClickListener {
            if (validateInputs()) {
                addParticipant()
            }
        }

        binding.btnClose.setOnClickListener {
            dismiss()
        }
    }

    private fun observeParticipants() {
        payerViewModel.getPayersByEvent(eventId).observe(viewLifecycleOwner) { participants ->
            if (participants.isEmpty()) {
                binding.participantsRecyclerView.visibility = View.GONE
                binding.emptyStateText.visibility = View.VISIBLE
            } else {
                binding.participantsRecyclerView.visibility = View.VISIBLE
                binding.emptyStateText.visibility = View.GONE
                adapter.submitList(participants)
            }
        }
    }

    private fun validateInputs(): Boolean {
        val participantName = binding.payerNameInput.text.toString()
        if (participantName.isBlank()) {
            binding.payerNameInputLayout.error = "Le nom du participant est requis"
            return false
        }
        binding.payerNameInputLayout.error = null
        return true
    }

    private fun addParticipant() {
        val participantName = binding.payerNameInput.text.toString()
        val contact = binding.payerContactInput.text?.toString()
        val montantStr = binding.payerMontantInput.text?.toString()
        
        // Accepter les virgules et les points comme séparateurs décimaux
        val montantPersonnalise = if (!montantStr.isNullOrBlank()) {
            val montant = montantStr.replace(",", ".").toDoubleOrNull()
            if (montant != null && montant <= 0) {
                binding.payerMontantInputLayout.error = "Le montant doit être supérieur à 0"
                return
            }
            if (montant == null && montantStr.isNotBlank()) {
                binding.payerMontantInputLayout.error = "Veuillez entrer un montant valide (ex: 500 ou 500.50)"
                return
            }
            montant
        } else {
            null
        }
        
        binding.payerMontantInputLayout.error = null

        viewLifecycleOwner.lifecycleScope.launch {
            val newParticipant = Payer(
                eventId = eventId,
                nom = participantName,
                contact = contact,
                montantPersonnalise = montantPersonnalise
            )

            try {
                payerViewModel.insertPayer(newParticipant)
                Toast.makeText(requireContext(), "Participant ajouté avec succès", Toast.LENGTH_SHORT).show()
                
                binding.payerNameInput.text?.clear()
                binding.payerContactInput.text?.clear()
                binding.payerMontantInput.text?.clear()
            } catch (e: Exception) {
                Toast.makeText(requireContext(), "Erreur: ${e.message}", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun deleteParticipant(payer: Payer) {
        viewLifecycleOwner.lifecycleScope.launch {
            try {
                payerViewModel.deletePayer(payer)
                Toast.makeText(requireContext(), "Participant supprimé", Toast.LENGTH_SHORT).show()
            } catch (e: Exception) {
                Toast.makeText(requireContext(), "Erreur lors de la suppression: ${e.message}", Toast.LENGTH_SHORT).show()
            }
        }
    }

    override fun onDestroyView() {
        super.onDestroyView()
        _binding = null
    }

    companion object {
        const val TAG = "ManageParticipantsDialog"
    }
}
